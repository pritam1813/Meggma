{%- comment -%}
  Announcement Bar Section
  - Multiple announcement blocks with rich text
  - GSAP fade-in animation from below
  - Close button with localStorage persistence
  - Auto-rotation for multiple announcements
  - Customizable colors
{%- endcomment -%}

{%- liquid
  assign bg_color = section.settings.background_color | default: '#000000'
  assign text_color = section.settings.text_color | default: '#ffffff'
  assign text_size = section.settings.text_size | default: 'text-sm'
  assign autoplay_speed = section.settings.autoplay_speed | default: 5
  assign show_close_button = section.settings.show_close_button
  assign storage_key = 'announcement-bar-' | append: section.id | append: '-closed'
-%}

{%- style -%}
  #announcement-bar-{{ section.id }} {
    --announcement-bg: {{ bg_color }};
    --announcement-text: {{ text_color }};
  }

  #announcement-bar-{{ section.id }} .announcement-wrapper {
    background-color: var(--announcement-bg);
    color: var(--announcement-text);
  }

  #announcement-bar-{{ section.id }} .announcement-content {
    opacity: 0;
    transform: translateY(100%);
  }

  #announcement-bar-{{ section.id }} .announcement-content a {
    color: var(--announcement-text);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  #announcement-bar-{{ section.id }} .announcement-content a:hover {
    opacity: 0.8;
  }

  #announcement-bar-{{ section.id }} .announcement-slide {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
  }

  #announcement-bar-{{ section.id }} .announcement-slide.active {
    opacity: 1;
  }

  #announcement-bar-{{ section.id }} .close-btn {
    color: var(--announcement-text);
    transition: opacity 0.2s ease;
  }

  #announcement-bar-{{ section.id }} .close-btn:hover {
    opacity: 0.7;
  }
{%- endstyle -%}

<section
  id="announcement-bar-{{ section.id }}"
  class="w-full"
  data-section-id="{{ section.id }}"
  data-storage-key="{{ storage_key }}"
  data-autoplay-speed="{{ autoplay_speed }}"
  style="display: none;"
>
  <div class="announcement-wrapper relative py-2 md:py-3 px-4 md:px-6">
    <div class="announcement-content flex items-center justify-center w-full">
      {%- if section.blocks.size > 1 -%}
        {%- comment -%} Multiple announcements - carousel {%- endcomment -%}
        <div class="announcement-carousel relative w-full h-6 md:h-7 overflow-hidden">
          {%- for block in section.blocks -%}
            <div
              class="announcement-slide {{ text_size }} text-center {% if forloop.first %}active{% endif %}"
              data-slide-index="{{ forloop.index0 }}"
              {{ block.shopify_attributes }}
            >
              {{ block.settings.text }}
            </div>
          {%- endfor -%}
        </div>
      {%- elsif section.blocks.size == 1 -%}
        {%- comment -%} Single announcement {%- endcomment -%}
        <div class="{{ text_size }} text-center" {{ section.blocks.first.shopify_attributes }}>
          {{ section.blocks.first.settings.text }}
        </div>
      {%- else -%}
        {%- comment -%} No announcements - show placeholder in editor {%- endcomment -%}
        <div class="{{ text_size }} text-center opacity-60">Add announcement blocks</div>
      {%- endif -%}
    </div>

    {%- if show_close_button -%}
      <button
        type="button"
        class="close-btn absolute right-3 md:right-6 top-1/2 -translate-y-1/2 p-1"
        aria-label="Close announcement"
        data-close-announcement
      >
        <svg
          width="18"
          height="18"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M18 6 6 18"/>
          <path d="m6 6 12 12"/>
        </svg>
      </button>
    {%- endif -%}
  </div>
</section>

<script>
  (function () {
    const sectionId = '{{ section.id }}';
    const section = document.getElementById('announcement-bar-' + sectionId);

    if (!section) return;

    const storageKey = section.dataset.storageKey;
    const autoplaySpeed = parseInt(section.dataset.autoplaySpeed) * 1000;
    const content = section.querySelector('.announcement-content');
    const closeBtn = section.querySelector('[data-close-announcement]');
    const slides = section.querySelectorAll('.announcement-slide');

    let currentSlide = 0;
    let autoplayInterval = null;

    // Check if announcement was previously closed
    function isBarClosed() {
      try {
        return localStorage.getItem(storageKey) === 'true';
      } catch (e) {
        return false;
      }
    }

    // Close the announcement bar
    function closeBar() {
      if (!window.gsap) {
        section.style.display = 'none';
        return;
      }

      gsap.to(content, {
        opacity: 0,
        y: -20,
        duration: 0.3,
        ease: 'power2.in',
        onComplete: () => {
          section.style.display = 'none';
          try {
            localStorage.setItem(storageKey, 'true');
          } catch (e) {
            // localStorage not available
          }
        },
      });

      if (autoplayInterval) {
        clearInterval(autoplayInterval);
      }
    }

    // Show the announcement bar with animation
    function showBar() {
      section.style.display = 'block';

      if (!window.gsap) {
        content.style.opacity = '1';
        content.style.transform = 'translateY(0)';
        return;
      }

      gsap.to(content, {
        opacity: 1,
        y: 0,
        duration: 0.5,
        ease: 'power2.out',
        delay: 0.2,
      });
    }

    // Rotate to next slide
    function nextSlide() {
      if (slides.length <= 1 || !window.gsap) return;

      const currentEl = slides[currentSlide];
      currentSlide = (currentSlide + 1) % slides.length;
      const nextEl = slides[currentSlide];

      gsap.to(currentEl, {
        opacity: 0,
        y: -10,
        duration: 0.3,
        ease: 'power2.in',
        onComplete: () => {
          currentEl.classList.remove('active');
        },
      });

      gsap.fromTo(
        nextEl,
        { opacity: 0, y: 10 },
        {
          opacity: 1,
          y: 0,
          duration: 0.3,
          ease: 'power2.out',
          delay: 0.1,
          onStart: () => {
            nextEl.classList.add('active');
          },
        }
      );
    }

    // Start autoplay for carousel
    function startAutoplay() {
      if (slides.length <= 1) return;
      autoplayInterval = setInterval(nextSlide, autoplaySpeed);
    }

    // Initialize
    function init() {
      if (isBarClosed()) {
        section.style.display = 'none';
        return;
      }

      showBar();
      startAutoplay();

      if (closeBtn) {
        closeBtn.addEventListener('click', closeBar);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>

{% schema %}
{
  "name": "Announcement Bar",
  "class": "announcement-bar-section",
  "settings": [
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Text"
    },
    {
      "type": "select",
      "id": "text_size",
      "label": "Text size",
      "options": [
        { "value": "text-xs", "label": "Extra Small" },
        { "value": "text-sm", "label": "Small" },
        { "value": "text-base", "label": "Medium" },
        { "value": "text-lg", "label": "Large" }
      ],
      "default": "text-sm"
    },
    {
      "type": "header",
      "content": "Carousel"
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "label": "Time between announcements",
      "min": 3,
      "max": 10,
      "step": 1,
      "default": 5,
      "unit": "s"
    },
    {
      "type": "header",
      "content": "Close Button"
    },
    {
      "type": "checkbox",
      "id": "show_close_button",
      "label": "Show close button",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "announcement",
      "name": "Announcement",
      "settings": [
        {
          "type": "richtext",
          "id": "text",
          "label": "Announcement text",
          "default": "<p>Free shipping on orders over $50! <a href=\"/collections/all\">Shop now</a></p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Announcement Bar",
      "blocks": [
        {
          "type": "announcement",
          "settings": {
            "text": "<p>Free shipping on orders over $50! <a href=\"/collections/all\">Shop now</a></p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}
