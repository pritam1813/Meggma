<section id="main-parallax" class="h-screen w-full relative overflow-hidden bg-black">
  <div id="bg-img" class="absolute top-0 left-0 w-full h-[130vh] z-0">
    {%- if section.settings.background_image != blank -%}
      <img
        src="{{ section.settings.background_image | image_url: width: 1920 }}"
        alt="{{ section.settings.background_image.alt | default: 'Background' }}"
        class="w-full h-full object-cover opacity-80"
        width="{{ section.settings.background_image.width }}"
        height="{{ section.settings.background_image.height }}"
      >
    {%- else -%}
      <img
        src="https://images.unsplash.com/photo-1767547708642-97afe4b4e583?crop=entropy&cs=srgb&fm=jpg&ixid=M3wzMjM4NDZ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3NjgzMDM1MzN8&ixlib=rb-4.1.0&q=85"
        alt="Background"
        class="w-full h-full object-cover opacity-80"
        width="1920"
        height="1080"
      >
    {%- endif -%}
  </div>

  <div class="absolute inset-0 z-10 w-full h-full pointer-events-none">
    {%- comment -%} Media Gallery Block - Dynamic {%- endcomment -%}
    {%- assign media_blocks = section.blocks | where: 'type', 'media_card' -%}
    {%- if media_blocks.size > 0 -%}
      <div class="parallax-subsection absolute inset-0 flex items-center justify-center space-x-16 md:space-x-24 px-12 w-full h-full">
        {%- for block in media_blocks limit: 3 -%}
          <div
            class="w-1/3  bg-transparent rounded-xl overflow-hidden"
            {{ block.shopify_attributes }}
          >
            {%- if block.settings.media_type == 'video' and block.settings.video != blank -%}
              <video
                class="w-full h-full object-contain aspect-9/16"
                autoplay
                muted
                loop
                playsinline
              >
                {%- for source in block.settings.video.sources -%}
                  <source src="{{ source.url }}" type="{{ source.mime_type }}">
                {%- endfor -%}
              </video>
            {%- elsif block.settings.image != blank -%}
              <img
                src="{{ block.settings.image | image_url: width: 800 }}"
                alt="{{ block.settings.image.alt | default: 'Hero media' }}"
                class="w-full h-full object-cover"
                width="{{ block.settings.image.width }}"
                height="{{ block.settings.image.height }}"
                loading="lazy"
              >
            {%- else -%}
              {{ 'image' | placeholder_svg_tag: 'w-full h-full object-cover bg-gray-700' }}
            {%- endif -%}
          </div>
        {%- endfor -%}
      </div>
    {%- endif -%}

    <div class="parallax-subsection absolute inset-0 flex items-center justify-center w-full h-full">
      <div class="bg-white text-black p-12 rounded-2xl max-w-2xl shadow-2xl text-center">
        <h2 class="text-4xl font-bold mb-4">Subsection Two</h2>
        <p class="text-lg">This slides up immediately after the first one leaves.</p>
      </div>
    </div>

    <div class="parallax-subsection absolute inset-0 flex items-center justify-center w-full h-full">
      <div class="bg-blue-600 text-white p-12 rounded-2xl max-w-2xl shadow-2xl text-center">
        <h2 class="text-4xl font-bold mb-4">Subsection Three</h2>
        <p class="text-lg">The background is still moving slowly behind us.</p>
      </div>
    </div>
  </div>
</section>

{%- comment -%} Section-specific GSAP animations {%- endcomment -%}
<script>
  (function () {
    function initHeroAnimations() {
      gsap.registerPlugin(ScrollTrigger);

      // 1. Select items
      const subsections = gsap.utils.toArray('.parallax-subsection');
      const bgImage = document.querySelector('#bg-img img');

      // 2. Initial Setup: Push all subsections down (off-screen)
      gsap.set(subsections, { yPercent: 100 });

      // 3. Create the Timeline
      const tl = gsap.timeline({
        scrollTrigger: {
          trigger: '#main-parallax',
          start: 'top top',
          end: '+=' + subsections.length * 100 + '%',
          scrub: 1,
          pin: true,
        },
      });

      // 4. THE CAROUSEL LOOP
      subsections.forEach((section, index) => {
        const startTime = index;

        // Slide IN (Enter)
        tl.to(
          section,
          {
            yPercent: 0,
            ease: 'none',
            duration: 1,
          },
          startTime
        );

        // Slide OUT (Exit) - If it's not the last one
        if (index < subsections.length - 1) {
          tl.to(
            section,
            {
              yPercent: -100,
              ease: 'none',
              duration: 1,
            },
            startTime + 1
          );
        }
      });

      // 5. THE BACKGROUND MOVEMENT (Runs parallel to everything)
      tl.to(
        bgImage,
        {
          yPercent: -15,
          ease: 'none',
          duration: subsections.length + 1,
        },
        0
      );
    }

    // Run when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initHeroAnimations);
    } else {
      initHeroAnimations();
    }
  })();
</script>

{% schema %}
{
  "name": "Hero",
  "settings": [
    {
      "type": "header",
      "content": "Background"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background Image"
    }
  ],
  "blocks": [
    {
      "type": "media_card",
      "name": "Media Card",
      "limit": 3,
      "settings": [
        {
          "type": "select",
          "id": "media_type",
          "label": "Media Type",
          "options": [
            {
              "value": "image",
              "label": "Image"
            },
            {
              "value": "video",
              "label": "Video"
            }
          ],
          "default": "image"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Used when Media Type is set to Image"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video",
          "info": "Upload videos via Settings > Files. Used when Media Type is set to Video"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Hero",
      "category": "Content",
      "blocks": [
        {
          "type": "media_card"
        },
        {
          "type": "media_card"
        }
      ]
    }
  ]
}
{% endschema %}
